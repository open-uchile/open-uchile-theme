<%page expression_filter="h"/>
<%!
    import json
    from django.utils.translation import ugettext as _
    from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
    from openedx.core.djangolib.js_utils import dump_js_escaped_json
    from urllib.parse import urlencode
    from django.urls import reverse
%>
<%namespace name='static' file='/static_content.html'/>

<%inherit file="../main.html" />

<%block name="pagetitle">${_("Sign in or Register")}</%block>

<%block name="js_extra">
    <%static:require_module module_name="js/student_account/logistration_factory" class_name="LogistrationFactory">
        var options = ${data | n, dump_js_escaped_json};
        LogistrationFactory(options);
        if ('newrelic' in window) {
            newrelic.finished();
            // Because of a New Relic bug, the finished() event doesn't show up
            // in Insights, so we have to make a new PageAction that is basically
            // the same thing. We still want newrelic.finished() for session
            // traces though.
            newrelic.addPageAction('xfinished');
        }
    </%static:require_module>
    % if configuration_helpers.get_value('DISPLAY_TOS_IN_MODAL_ON_REGISTRATION_PAGE', False):
    <script type="text/javascript" src="${static.url('js/student_account/tos_modal.js')}"></script>
    % endif
</%block>

<%block name="header_extras">
    % for template_name in ["account", "access", "form_field", "register", "institution_login", "institution_register", "password_reset", "hinted_login"]:
        <script type="text/template" id="${template_name}-tpl">
            <%static:include path="student_account/${template_name}.underscore" />
        </script>
    % endfor
    <script type="text/template" id="login-tpl">
        <%static:include path="student_account/login2.underscore" />
    </script>
</%block>
<div style="visibility: hidden;" id="url_next">${ reverse('eol_sso_login:uchile_login') | h }?${urlencode({'next':login_redirect_url})}</div>
<div class="container px-3 mt-2">
    <div class="card col-11 col-md-8 col-lg-7 mx-auto shadow-lg px-5 py-4 mb-5 rounded-lg" id="content-container">
        % if enable_enterprise_sidebar:
            <%include file="enterprise_sidebar.html" />
            <%
                border_class = 'border-left'
            %>
        % else:
            <%
                border_class = ''
            %>
        % endif
        <div id="login-and-registration-container" class="login-register ${border_class}"></div>
    </div>
</div>
<script type="text/javascript">
    //LOGIN

    window.addEventListener("load", (event) => {
        $('#first_time span').html('${_("¿No tienes cuenta en Open UChile?") }');
        $('#first_time a').html('${_("Crear Cuenta") }');
    });
    function clean_form(){
        $('#next_btn').hide();
        $('#create_text').text('');
        $('#eol_verification_msg').text('');
        $('#login_btn').hide();
        $('#create_account_login').hide();
        $('#sso_btn').hide();
        $('#clean_btn_login').hide();
        $('#first_time').hide();
        $('#no_active_btn').hide();
        $('.form-field.password-password').hide();
    }
    function msg_login(msg){
        $('#create_text').text(msg);
    }
    $('#login-email').live('keydown', function(e) {
        if(e.keyCode === 13){
            e.preventDefault();
            e.stopPropagation();
        }
    });

    function check_sso_email(){
        clean_form();
        let email = $('#login-email').val();
        $.post( "/eol_sso_login/api/email/", {email: email} )
        .done(function( data ) {
            if (data.result == 'success'){
                $('#clean_btn_login').show();
                if(data.exists){
                    if(data.active){
                        if(data.have_sso){
                            $('#sso_btn').text('${_("Sign in with Mi.UChile") }');
                            $('#sso_btn').show();
                            $('#first_time').hide();
                        }
                        else{
                            $('#sso_btn').hide();
                            $('#login_btn').show();
                            $('.form-field.password-password').show();
                        }
                    }
                    else {
                        msg_login('${_("Account not active") }');
                        $('#no_active_btn').show();
                    }
                }
                else{
                    msg_login('${_("There is no account associated with the email entered") }');
                    $('#create_account_login').show();
                }
            }
            else {
                $('#create_text').text('${_("Enter email") }');
                $('#next_btn').show();
                $('#first_time').show();
            }
            
        })
        .fail(function() {
            msg_login('${_("Unexpected error, refresh the page and try again, if the error persists contact the help desk") }');
        });
    }

    $('#next_btn').live('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        check_sso_email();
    });
    $('#sso_btn').live('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        var url = document.getElementById("url_next").textContent;
        window.location.href = url;
    });
    $('#no_active_btn').live('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        clean_form();
        let email = $('#login-email').val();
        send_activation_email(email);
    });
    function send_activation_email(email){
        $.post( "/eol_sso_login/api/send_activation_email/", {email: email} )
        .done(function( data ) {
            if (data.result == 'success'){
                $('#no_active_btn').hide();
                $('form#login').hide();
                $('#eol_verification_msg').show();
                $('#eol_verification_msg').text('${_("Correo de verificaión enviado") }');
            }
            else {
                $('#clean_btn_login').show();
                if(data.error == "no_email") $('#create_text').text('${_("Enter email") }');
                if(data.error == "email_no_exists") $('#create_text').text('${_("There is no account associated with the email entered") }');
            }
        })
        .fail(function() {
            msg_login('${_("Unexpected error, refresh the page and try again, if the error persists contact the help desk") }');
        });
    }
    $('#clean_btn_login').live('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $('#login-email').val('');
        $('#login-password').val('');
        clean_form();
        $('#next_btn').show();
        $('#first_time').show();
    })
    // REGISTER

    $('form#register button#sso_btn_register').live('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        var url = document.getElementById("url_next").textContent;
        window.location.href = url;
    });
    function show_hide_form(show){
        if(show){
            $(".form-field.email-email").show();
            $(".form-field.text-name").show();
            $(".form-field.text-username").show();
            $(".form-field.password-password").show();
            $(".form-field.select-country").show();
            $(".form-field.select-gender").show();
            $(".form-field.select-year_of_birth").show();
            $(".form-field.select-level_of_education").show();
        }
        else{
            $(".form-field.email-email").hide();
            $(".form-field.text-name").hide();
            $(".form-field.text-username").hide();
            $(".form-field.password-password").hide();
            $(".form-field.select-country").hide();
            $(".form-field.select-gender").hide();
            $(".form-field.select-year_of_birth").hide();
            $(".form-field.select-level_of_education").hide();
        }
    }
    $('#clean_btn_register').live('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        show_hide_form(false);
        $('form#register button#sso_btn_register').hide();
        $('form#register button#next_btn_register').show();
        $('form#register button[type="submit"]').hide();
        $('form#register')[0].reset();
        $('#register-type_document-validation-error-msg').html('');
        $('#register-document-validation-error-msg').html('');
        $('#register-email-validation-error-msg').html('');
        $('#register-name-validation-error-msg').html('');
        $('#register-username-validation-error-msg').html('');
        $('#register-password-validation-error-msg').html('');
        $('#register-country-validation-error-msg').html('');
        $('#register-gender-validation-error-msg').html('');
        $('#register-year_of_birth-validation-error-msg').html('');
        $('#register-level_of_education-validation-error-msg').html('');
        $("form#register .error.fa-exclamation").removeClass('error').removeClass('fa-exclamation');
        $("form#register .label-required.error").addClass('hidden');
        $("form#register .label-required.error").addClass('hidden');
        $("form#register .label-required.error").removeClass('error');
        $("form#register .focus-in.error").removeClass('error');
    } );
    $('#next_btn_register').live('click', function(e) {
        e.preventDefault();
        //e.stopPropagation();
        $('form#register button#sso_btn_register').hide();
        $('form#register button#next_btn_register').hide();
        $('form#register button[type="submit"]').hide();
        let type_document = $('#register-type_document').val();
        let document = $('#register-document').val();
        $.post( "/eol_sso_login/api/registration/", {document: document, type_document: type_document} )
        .done(function( data ) {
            if(data.result == 'error'){
                $('form#register button#next_btn_register').show();
                $('#register-document-validation-error').removeClass('hidden');
                $('label[for="register-document"]').removeClass('success').addClass('error');
                $('#register-document-required-label').removeClass('success');
                $('#register-document-validation-icon').removeClass('success').removeClass('fa-check');
                if(data.error == "no_document") $('#register-document-validation-error-msg').html('${_("Enter document number") }');
                if(data.error == "document_length") $('#register-document-validation-error-msg').html('${_("The document number must be between 5 and 20 characters") }');
                if(data.error == "no_type_document") $('#register-document-validation-error-msg').html('${_("Select a document type") }');
                if(data.error == "wrong_document") $('#register-document-validation-error-msg').html('${_("The document number must be alphanumeric") }');
                if(data.error == "wrong_rut") $('#register-document-validation-error-msg').html('${_("Incorrect Rut") }');
                if(data.error == "document_exists") $('#register-document-validation-error-msg').html('${_("Document number already exists on the platform") }');
            }
            else{
                $('form#register button#next_btn_register').show();
                $('#register-document-validation-error-msg').html('')
                $('#register-document-validation-error').addClass('hidden');
                $('label[for="register-document"]').addClass('success').removeClass('error');
                $('#register-document-required-label').addClass('success');
                $('#register-document-validation-icon').addClass('success').addClass('fa-check');
                $('form#register button[type="submit"]').prop("disabled",false);
                $('form#register button[type="submit"]').show();
                if(type_document == 'rut'){
                    $('form#register button#next_btn_register').hide();
                    if(data.have_sso){
                        $('form#register button[type="submit"]').prop("disabled",true);
                        $('form#register button[type="submit"]').hide();
                        $('form#register button#sso_btn_register')[0].innerText = '${_("Sign in with Mi.UChile") }';
                        $('form#register button#sso_btn_register').show();
                    }
                    else{
                        show_hide_form(true);
                        $('form#register button[type="submit"]').prop("disabled",false);
                        $('form#register button[type="submit"]').show();
                    }
                }
            }
        })
        .fail(function() {
            $('#register-document-validation-error').removeClass('hidden');
            $('label[for="register-document"]').removeClass('success').addClass('error');
            $('#register-document-required-label').removeClass('success');
            $('#register-document-validation-icon').removeClass('success').removeClass('fa-check');
            $('#register-document-validation-error-msg').html('${_("Unexpected error, please update and try again") }');
            $('form#register button[type="submit"]').remove();
            $('form#register button#SSO_btn').remove();
        });
    } )
</script>
